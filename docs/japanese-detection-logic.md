# 日本語サイト検出ロジック

## 1. 検出方法の優先順位

### 1.1 HTMLのlang属性（最優先）
```javascript
// 検出対象
- <html lang="ja">
- <html lang="ja-JP">
```
- lang属性が日本語を示す場合、即座に日本語サイトと判定
- lang属性が他の言語を示す場合は、テキスト分析に進む

### 1.2 文字種別分析
ページ内のテキストコンテンツを分析し、日本語文字の割合を計算：

```javascript
// 日本語文字の判定基準
- ひらがな: \u3040-\u309F
- カタカナ: \u30A0-\u30FF
- 漢字: \u4E00-\u9FAF

// 判定基準
- 日本語文字が全体の20%以上 → 日本語サイト
- title, h1-h6, pタグ（最初の10個）を優先的に分析
- 空白文字は文字数にカウントしない
```

## 2. デフォルトIMEモードの選択肢

### 2.1 "on" - IME常時ON
- 推測できなかったフィールドは日本語入力可能
- 一般的な日本語サイトに適用
- ブログ、ニュースサイト、ECサイトなど

### 2.2 "off" - IME常時OFF
- 推測できなかったフィールドは半角英数
- 技術系サイト、開発者向けサイトに適用
- GitHub、プログラミング関連サイトなど

### 2.3 "auto" - 自動判定（デフォルト）
- フィールドの周辺テキストから判断
- 判定できない場合は "on" として扱う

## 3. 検出方法の詳細

### 3.1 言語検出の流れ
1. HTMLのlang属性をチェック
   - `ja`または`ja-JP`の場合 → 日本語サイトとして確定
   - その他の言語の場合 → テキスト分析へ
   - lang属性がない場合 → テキスト分析へ

2. テキスト分析
   - 重要な要素（title、見出し、段落）からテキストを抽出
   - 日本語文字（ひらがな、カタカナ、漢字）の割合を計算
   - 20%以上が日本語文字なら日本語サイトと判定

### 3.2 なぜドメインでの判定を除外したか
- `.jp`ドメインでも英語サイトが多数存在（例：大学、企業の英語版）
- `.com`や`.org`でも日本語サイトが多数存在（例：グローバル企業の日本語版）
- ドメイン名は言語を正確に反映しないため、誤判定の原因となる

## 4. ユーザー設定の反映

### 4.1 グローバル設定
- `autoEnableJapaneseSites`: 日本語サイトの自動有効化

### 4.2 サイト個別設定
- 自動検出を上書き可能
- ユーザーが明示的に設定した場合は、それを優先

### 4.3 学習機能（将来的な拡張）
- ユーザーの設定パターンを学習
- 類似サイトへの適用を提案